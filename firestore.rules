/**
 * @fileOverview Firestore Security Rules for the Memora application.
 *
 * Core Philosophy:
 * This ruleset prioritizes user and family data ownership.  Users can only
 * read and write their own profile data. Families can manage their own stories
 * and Memora Boxes. Public listing of users is disallowed.
 *
 * Data Structure:
 * - /users/{userId}: Stores individual user profiles.
 * - /families/{familyId}: Stores family account information.
 * - /families/{familyId}/stories/{storyId}: Stores stories for each family.
 * - /families/{familyId}/memoraBoxes/{boxId}: Stores Memora Box device data.
 * - /donatedStories/{donatedStoryId}: Stores anonymized donated stories.
 *
 * Key Security Decisions:
 * - User listing is explicitly denied.
 * - Users can only create their own user document (self-creation).
 * - Families manage stories and boxes.
 * - Donated stories are publicly readable and written via Admin SDK.
 *
 * Denormalization for Authorization:
 *  - The `User` entity has a `familyId` field to determine the family a user belongs to, which simplifies rules for stories and boxes.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Ensures only the authenticated user can manage their own profile.
     * @path /users/{userId}
     * @allow (create) User with ID matching auth UID can create their profile.
     * @allow (get, update, delete) User with ID matching auth UID can get, update, or delete their profile.
     * @deny (list) Listing users is not allowed.
     * @deny (update) User cannot change their own familyId.
     * @principle Enforces user-ownership for profile data.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false; // Prevent user enumeration

      allow create: if isOwner(userId) && request.resource.data.id == userId;
      // User cannot change their familyId, and the doc ID must remain the same.
      allow update: if isOwner(userId)
                    && request.resource.data.id == resource.data.id
                    && request.resource.data.familyId == resource.data.familyId;
      allow delete: if isOwner(userId);
    }

    // Helper function to check for family membership.
    function isFamilyMember(familyId) {
      return get(/databases/$(database)/documents/families/$(familyId)).data.memberIds.hasAny([request.auth.uid]);
    }

    /**
     * @description Restricts family management to family members, particularly the admin.
     * @path /families/{familyId}
     * @allow (create) The creating user must be the admin and a member.
     * @allow (get) Only family members can read family data.
     * @allow (update) Only the family admin can update the family.
     * @allow (delete) Only the family admin can delete the family.
     * @deny (list) Listing families is not allowed.
     * @principle Enforces family ownership and admin control.
     */
    match /families/{familyId} {
      function isAdmin(familyId) {
        return get(/databases/$(database)/documents/families/$(familyId)).data.adminId == request.auth.uid;
      }

      allow get: if isFamilyMember(familyId);
      allow list: if false;

      // The user creating the family must be listed as the admin and be in the initial member list.
      allow create: if request.resource.data.adminId == request.auth.uid
                    && request.resource.data.memberIds.hasAny([request.auth.uid]);
      allow update: if isAdmin(familyId);
      allow delete: if isAdmin(familyId);
    }

    /**
     * @description Manages stories within a family, allowing family members to contribute and manage them.
     * @path /families/{familyId}/stories/{storyId}
     * @allow (create, update, delete) Family members can create, update, and delete stories.
     * @allow (get, list) Only family members can read or list stories.
     * @principle Enforces family-based access control for stories.
     */
    match /families/{familyId}/stories/{storyId} {
      allow get, list: if isFamilyMember(familyId);
      allow create, update, delete: if isFamilyMember(familyId);
    }

    /**
     * @description Manages Memora Box devices within a family.
     * @path /families/{familyId}/memoraBoxes/{boxId}
     * @allow (create, update, delete) Family members can manage boxes.
     * @allow (get, list) Only family members can read or list boxes.
     * @principle Enforces family-based access control for Memora Boxes.
     */
    match /families/{familyId}/memoraBoxes/{boxId} {
        allow get, list: if isFamilyMember(familyId);
        allow create, update, delete: if isFamilyMember(familyId);
    }

    /**
     * @description Allows public read access to donated stories.
     * @path /donatedStories/{donatedStoryId}
     * @allow (get, list) Any user can read donated stories.
     * @deny (create, update, delete) All client-side writes are forbidden.
     * @principle Provides public access to donated stories. Writes must be handled by a backend process with Admin privileges.
     */
    match /donatedStories/{donatedStoryId} {
      allow get, list: if true;
      // Writes are handled by backend functions with Admin SDK, not by clients.
      allow write: if false;
    }
  }
}